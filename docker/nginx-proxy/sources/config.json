{
  "docker": {
    "host": "unix:///var/run/docker.sock"
  },

  "routes": [
    {
      "scope": "swarm",
      "actions": ["init", "start", "update", "unpause", "die", "kill", "stop", "pause", "oom", "destroy"],
      "source": "{{ .config.BaseDir }}/swarm.services.tpl",
      "target": "/etc/nginx/vhost.d/services.conf"
    },
    {
      "scope": "swarm",
      "actions": ["init"],
      "daemon": true,
      "cmd": "nginx -g 'daemon off;'"
    },
    {
      "each": true,
      "scope": "swarm",
      "actions": ["init", "start", "update", "unpause", "die", "kill", "stop", "pause", "oom", "destroy"],
      "condition": "{{ if (and (eq (index .service.Spec.Labels \"service.web.enable\") \"true\") (index .service.Spec.Labels \"service.web.frontend.auth.basic\")) }}true{{ end }}",
      "cmd": "echo '{{ index .service.Spec.Labels \"service.web.frontend.auth.basic\" }}' > /etc/nginx/vhost.d/.{{ coalesce (index .service.Spec.Labels \"service.name\") (index .service.Spec.Labels \"com.docker.swarm.service.name\") .service.Spec.Name }}.htpasswd"
    },
    {
      "name_pattern": "",
      "scope": "swarm",
      "actions": ["init", "start", "update", "unpause", "die", "kill", "stop", "pause", "oom", "destroy"],
      "cmd": "{{ .config.BaseDir }}/nginx-reload.sh /etc/nginx/vhost.d/services.conf"
    }
  ]
}