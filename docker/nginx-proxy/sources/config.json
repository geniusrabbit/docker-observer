{
  "docker": {
    "host": "unix:///var/run/docker.sock"
  },

  "routes": [
    {
      "scope": "swarm",
      "actions": ["init", "refresh", "create", "update", "remove", "start", "pause", "unpause", "stop", "die", "kill", "destroy"],
      "source": "{{ .config.BaseDir }}/swarm.services.tpl",
      "target": "/etc/nginx/vhost.d/services.conf"
    },
    {
      "scope": "swarm",
      "actions": ["init"],
      "daemon": true,
      "cmd": "nginx -g 'daemon off;'"
    },
    {
      "each": true,
      "scope": "swarm",
      "actions": ["init", "refresh", "create", "update", "remove", "start", "pause", "unpause", "stop", "die", "kill", "destroy"],
      "condition": "{{ $labales := .service.Service.Spec.Labels }}{{ if (and (eq (index $labales \"service.web.enable\") \"true\") (index $labales \"service.web.frontend.auth.basic\")) }}true{{ end }}",
      "cmd": "{{ $labales := .service.Service.Spec.Labels }}echo '{{ index $labales \"service.web.frontend.auth.basic\" }}' > /etc/nginx/vhost.d/.{{ coalesce (index $labales \"service.name\") (index $labales \"com.docker.swarm.service.name\") .service.Service.Spec.Name }}.htpasswd"
    },
    {
      "name_pattern": "",
      "scope": "swarm",
      "actions": ["init", "refresh", "create", "update", "remove", "start", "pause", "unpause", "stop", "die", "kill", "destroy"],
      "cmd": "{{ .config.BaseDir }}/nginx-reload.sh /etc/nginx/vhost.d/services.conf"
    }
  ]
}